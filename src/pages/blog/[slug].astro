---
import Layout from "../../layouts/Layout.astro";
import NavForPost from "../../components/NavForPost.astro";
import Feed from "../../components/Feed.astro";
import { client } from "../../lib/sanity.js";
import Post from "../../components/Post.astro";
import { getWorkPost as getPostBySlug } from "../../data/works";

export async function getStaticPaths() {
  const slugs = await client.fetch(`
    *[_type == "post"
      && postType == "blog"
      && defined(slug.current)
      && !(_id in path("drafts.**"))
    ]{
      "slug": slug.current
    }
  `);

  return slugs.map(({ slug }) => ({
    params: { slug },
    props: { postSlug: slug },
  }));
}

const { postSlug } = Astro.props;
const post = await getPostBySlug(postSlug);
if (!post) return Astro.redirect("/404");

// ✅ Use postDate or fallback to created date
const baseDate = post.postDate ?? post._createdAt;

// ✅ Find "previous" blog post (older)
let prev = await client.fetch(
  `
  *[_type=="post"
    && postType == "blog"
    && defined(slug.current)
    && !(_id in path("drafts.**"))
    && coalesce(postDate, _createdAt) < $d]
    | order(coalesce(postDate, _createdAt) desc)[0]{
      title,
      "slug": slug.current,
      postDate
    }
  `,
  { d: baseDate },
);

// ✅ WRAP: if no prev (you are on oldest blog post) -> go to newest
if (!prev) {
  prev = await client.fetch(
    `
    *[_type=="post"
      && postType=="blog"
      && defined(slug.current)
      && !(_id in path("drafts.**"))
      && slug.current != $current
    ]
    | order(coalesce(postDate, _createdAt) desc)[0]{
      title,
      "slug": slug.current,
      postDate
    }
    `,
    { current: postSlug },
  );
}

// ✅ Display date (fallback works too)
const postDate = (() => {
  const d = new Date(post.postDate ?? post._createdAt);
  return d.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
})();

const displayTitle =
  post.title && post.title.trim() !== "" ? post.title : postDate;
---

<Layout
  title={`Dzastins Zavadzkis—${postDate}`}
  description={`Blogpost of Dzastins Zavadzkis, ${post.title}`}
>
  <NavForPost title={displayTitle} slot="overlay" />

  <div class="post-page">
    <Feed>
      <Post post={post} />

      {
        prev ? (
          <nav class="post-pagination" aria-label="Blog post navigation">
            <div class="post-pagination__left" />

            <div class="post-pagination__right">
              <a
                class="prev-only"
                href={`/blog/${prev.slug}`}
                aria-label="Previous post"
                title={prev.title}
              >
                <span class="label">{prev.title}</span>
                <span class="arrow">→</span>
              </a>
            </div>
          </nav>
        ) : null
      }
    </Feed>
  </div>
</Layout>

<style lang="scss">
  .post-page {
    padding-bottom: 40px;
  }

  .post-pagination {
    margin-top: 40px;
    display: grid;
    grid-template-columns: 1fr auto; /* left fills, right hugs */
    align-items: start;
    column-gap: 10px;
  }

  .post-pagination__left {
    min-width: 0;
  }

  .post-pagination__right {
    justify-self: end; /* ✅ pinned right */
    min-width: max-content; /* ✅ no collapsing */
  }

  .prev-only {
    height: 38px;
    border-radius: var(--br);
    padding: 0 14px;
    text-decoration: none;
    color: #000;

    display: inline-flex;
    align-items: center;
    gap: 10px;

    width: max-content;
    max-width: clamp(220px, 42vw, 520px);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;

    box-shadow: var(--box-shadow);
    backdrop-filter: var(--backdrop-filter);
    -webkit-backdrop-filter: var(--backdrop-filter);

    transition:
      box-shadow 0.15s ease,
      backdrop-filter 0.15s ease;
  }

  .prev-only:hover {
    box-shadow: 0 0 3px rgba(122, 122, 122, 0.4) inset;
    backdrop-filter: var(--backdrop-filter-pressed);
    -webkit-backdrop-filter: var(--backdrop-filter-pressed);
  }

  .prev-only .label {
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .prev-only .arrow {
    flex: 0 0 auto;
  }
</style>
