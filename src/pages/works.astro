---
import Layout from "../layouts/Layout.astro";
import WorkPreview from "../components/WorkPreview.astro";
import { getPosts } from "../data/works";
import { supabaseAdmin } from "../lib/supabaseAdmin";

const works = await getPosts("works", "selectedWorkPosts");

// ✅ Supabase hidden previews (server-side)
const { data: hidden } = await supabaseAdmin
  .from("private_posts_preview")
  .select("slug,title,post_date,post_description,thumbs")
  .order("post_date", { ascending: false });

const hiddenPosts = hidden ?? [];

// ✅ Normalize into ONE array + sort
const allPosts = [
  ...works.map((w) => ({
    _source: "sanity",
    _sortDate: new Date(w.postDate).getTime() || 0,
    _raw: w,
  })),
  ...hiddenPosts.map((p) => ({
    _source: "supabase",
    slug: p.slug,
    title: p.title,
    postDate: p.post_date,
    postDescription: p.post_description,
    thumbs: Array.isArray(p.thumbs) ? p.thumbs : [],
    _sortDate: new Date(p.post_date).getTime() || 0,
  })),
].sort((a, b) => b._sortDate - a._sortDate);
---

<Layout
  title="Dzastins Zavadzkis—Works"
  description="Works and projects of Dzastins Zavadzkis.">
  <div class="works-page">
    <div class="work-feed" data-work-feed>
      {
        allPosts.map((post) => {
          if (post._source === "sanity") {
            return <WorkPreview workPost={post._raw} />;
          }

          const thumbs = post.thumbs ?? [];
          const year = post.postDate
            ? new Date(post.postDate).getFullYear()
            : "";

          return (
            <a href={`/works/${post.slug}`} data-locked="true" class="locked">
              <div class="work-preview" data-images={JSON.stringify(thumbs)}>
                <h2 class="work-title">{post.title}</h2>

                <p class="work-short-description">
                  <span class="ticker" data-ticker>
                    <span class="t1">{post.postDescription}</span>
                    <span class="t2">{post.postDescription}</span>
                  </span>
                </p>

                {thumbs.slice(0, 3).map((url) => (
                  <img class="work-image" src={url} loading="lazy" />
                ))}

                <span class="work-year">{year}</span>
              </div>
            </a>
          );
        })
      }
    </div>
  </div>

  {/* ✅ THIS is what was missing */}
  <div
    slot="overlay"
    class="unlock-overlay"
    data-unlock-overlay
    aria-hidden="true"
  >
    <div class="unlock-backdrop" data-unlock-backdrop></div>

    <div class="unlock-modal">
      <h2 class="unlock-title">Unlock Hidden Works</h2>

      <form
        method="POST"
        enctype="application/x-www-form-urlencoded"
        action="/.netlify/functions/private-ui-unlock"
        class="unlock-form"
        data-unlock-form
      >
        <input
          name="password"
          type="password"
          placeholder="Password"
          autocomplete="current-password"
          required
        />
        <button type="submit">OK</button>
      </form>

      <p class="unlock-error" data-unlock-error hidden>Wrong password</p>
    </div>
  </div>
</Layout>

<style lang="scss">
  .work-feed {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  :global(html.works-unlocked) a.locked .work-preview {
    filter: none;
    opacity: 1;
  }

  /* Overlay */
  .unlock-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000000;
    display: none;
    place-items: center;
  }

  .unlock-overlay.is-open {
    display: grid;
  }

  .unlock-backdrop {
    position: absolute;
    inset: 0;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    cursor: pointer;
  }

  .unlock-modal {
    position: relative;
    z-index: 1;
    width: min(92vw, 420px);
  }

  .unlock-title {
    margin: 0 0 10px;
    font-size: calc(var(--fz) * 0.6);
    text-align: center;
  }

  .unlock-form {
    display: flex;
    gap: 8px;
  }

  .unlock-form input {
    flex: 1;
    padding: 8px 10px;
    border-radius: var(--br);
    border: none;
    background: var(--pill-bg);
    font-size: var(--fz);
    height: 42px;

    backdrop-filter: var(--backdrop-filter);
    -webkit-backdrop-filter: var(--backdrop-filter);
    box-shadow: var(--box-shadow);
  }

  .unlock-form button {
    padding: 8px 12px;
    border-radius: var(--br);
    border: none;
    background: var(--pill-bg);
    height: 42px;

    backdrop-filter: var(--backdrop-filter);
    -webkit-backdrop-filter: var(--backdrop-filter);
    box-shadow: var(--box-shadow);
    font-size: var(--fz);
    cursor: pointer;
  }

  .unlock-error {
    margin-top: 10px;
    font-size: 12px;
    color: #b00020;
    text-align: center;
  }

  /* ✅ remove "cloud glow" behind blur */
  :global(html:has(.unlock-overlay.is-open)) .work-title,
  :global(html:has(.unlock-overlay.is-open)) .work-short-description,
  :global(html:has(.unlock-overlay.is-open)) .work-year {
    box-shadow: none !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }

  :global(html:has(.unlock-overlay.is-open)) .work-image {
    box-shadow: none !important;
  }
</style>
