---
import { client } from "../lib/sanity.js";
import { urlFor } from "../lib/sanity.js";
import Layout from "../layouts/FullBleedLayout.astro";

//------
//fetch homepage images from Sanity
//------
const data = await client.fetch(`
  *[_type == "homepage"][0]{
    featuredImages[]{
      asset->{
        _id,
        metadata { dimensions { width, height } }
      },
      alt
    }
  }
`);

const images = (data?.featuredImages ?? []).filter((img) => img?.asset);

//------
//build low-res placeholder URLs
//------
const lowResUrls = images.map((img) =>
  urlFor(img.asset).width(64).quality(20).url()
);

//------
//build hi-res URLs with reduced quality for bandwidth savings
//------
const hiResUrls = images.map((img) =>
  urlFor(img.asset).width(1920).quality(75).url()
);
---

<Layout title="Home">
  <div class="image-scroll" id="imageScroll">
    {images.map((img, index) => {
      const intrinsicWidth = img.asset?.metadata?.dimensions?.width ?? 1;
      const intrinsicHeight = img.asset?.metadata?.dimensions?.height ?? 1;

      return (
        <img
          class="scroll-image is-loading"
          src={lowResUrls[index]}
          data-hi={hiResUrls[index]}
          alt={img.alt ?? "Image"}
          width={intrinsicWidth}
          height={intrinsicHeight}
          loading="lazy"
          decoding="async"
        />
      );
    })}
  </div>
</Layout>

<script>
  (function () {
    const cleanupMap = new WeakMap();

    //------
    //find the active scroll root for intersection observer
    //------
    function getObserverRoot(containerElement) {
      const mainScroller = document.getElementById("mainScroller");
      if (mainScroller instanceof HTMLElement) return mainScroller;

      let parentElement = containerElement.parentElement;
      while (parentElement) {
        const overflowYValue = getComputedStyle(parentElement).overflowY;
        const isScrollableStyle = overflowYValue === "auto" || overflowYValue === "scroll";
        if (isScrollableStyle) return parentElement;
        parentElement = parentElement.parentElement;
      }

      return null;
    }

    //------
    //initialize progressive image loading
    //------
    function init() {
      const imageContainer = document.getElementById("imageScroll");
      if (!(imageContainer instanceof HTMLElement)) return;

      if (imageContainer.dataset.progressiveImagesInited === "1") return;
      imageContainer.dataset.progressiveImagesInited = "1";

      const imageElements = Array.from(imageContainer.querySelectorAll("img.scroll-image"));
      if (!imageElements.length) return;

      const observerRoot = getObserverRoot(imageContainer);

      //------
      //cache hi-res preloads by URL to avoid repeated preload work
      //------
      const hiResLoadCache = new Map();

      function preloadHiResOnce(hiResUrl) {
        const cachedPromise = hiResLoadCache.get(hiResUrl);
        if (cachedPromise) return cachedPromise;

        const loadPromise = new Promise((resolve, reject) => {
          const preloadImage = new Image();
          preloadImage.onload = () => resolve(undefined);
          preloadImage.onerror = () => reject(new Error("hi-res preload failed"));
          preloadImage.src = hiResUrl;
        });

        hiResLoadCache.set(hiResUrl, loadPromise);
        return loadPromise;
      }

      //------
      //upgrade a single image from low-res to hi-res
      //------
      function upgradeImage(imageElement) {
        if (!(imageElement instanceof HTMLImageElement)) return;

        const hiResUrl = imageElement.getAttribute("data-hi");
        if (!hiResUrl) return;

        if (imageElement.dataset.upgraded === "1") return;
        if (imageElement.dataset.upgrading === "1") return;

        imageElement.dataset.upgrading = "1";

        preloadHiResOnce(hiResUrl)
          .then(() => {
            imageElement.src = hiResUrl;
            imageElement.classList.remove("is-loading");
            imageElement.dataset.upgraded = "1";
            delete imageElement.dataset.upgrading;
          })
          .catch(() => {
            delete imageElement.dataset.upgrading;
          });
      }

      //------
      //upgrade images when they approach the viewport
      //------
      const hiResObserver = new IntersectionObserver(
        (entries) => {
          for (const entry of entries) {
            if (!entry.isIntersecting) continue;
            upgradeImage(entry.target);
          }
        },
        {
          root: observerRoot,
          rootMargin: "400px 0px",
          threshold: 0
        }
      );

      //------
      //register images with the observer
      //------
      function observeImages() {
        imageContainer.querySelectorAll("img.scroll-image").forEach((imageElement) => {
          if (!(imageElement instanceof HTMLImageElement)) return;
          if (!imageElement.getAttribute("data-hi")) return;
          if (imageElement.dataset.upgraded === "1") return;
          hiResObserver.observe(imageElement);
        });
      }

      observeImages();

      //------
      //clean up observer and init marker on page transitions
      //------
      function destroy() {
        hiResObserver.disconnect();
        delete imageContainer.dataset.progressiveImagesInited;
        cleanupMap.delete(imageContainer);
      }

      cleanupMap.set(imageContainer, destroy);
    }

    //------
    //run cleanup before Astro swaps pages
    //------
    function cleanup() {
      const imageContainer = document.getElementById("imageScroll");
      if (!(imageContainer instanceof HTMLElement)) return;

      const cleanupFn = cleanupMap.get(imageContainer);
      if (typeof cleanupFn === "function") cleanupFn();
    }

    //------
    //bind Astro lifecycle handlers once
    //------
    const rootElement = document.documentElement;
    if (rootElement.dataset.progressiveImagesBound !== "1") {
      rootElement.dataset.progressiveImagesBound = "1";
      document.addEventListener("astro:page-load", init);
      document.addEventListener("astro:after-swap", init);
      document.addEventListener("astro:before-swap", cleanup);
    }

    //------
    //initialize on first page load
    //------
    init();
  })();
</script>

<style lang="scss" is:global>
  // ------
  // keep image column full width
  // ------
  .image-scroll {
    width: 100vw;
  }

  //------
  //render responsive images in a vertical stack
  //------
  .scroll-image {
    display: block;
    width: 100vw;
    height: auto;
    object-fit: contain;
  }

  //------
  //show blur while hi-res image is loading
  //------
  .scroll-image.is-loading {
    filter: blur(6px);
    transform: scale(1.01);
  }
</style>